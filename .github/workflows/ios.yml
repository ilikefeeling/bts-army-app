name: Build and Release iOS App

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        type: environment
        required: true

jobs:
  build_ios:
    name: Build iOS App
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Build and Upload to App Store Connect
        uses: yukiarrr/ios-build-action@v1.11.1
        with:
          project-path: ios/App/App.xcodeproj
          workspace-path: ios/App/App.xcworkspace
          scheme: App
          export-method: app-store
          p12-base64: ${{ secrets.P12_BASE64 }}
          p12-password: ${{ secrets.P12_PASSWORD }}
          mobileprovision-base64: ${{ secrets.MOBILEPROVISION_BASE64 }}
          team-id: ${{ secrets.APPLE_TEAM_ID }}
          app-store-connect-api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
          app-store-connect-api-key-issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          app-store-connect-api-key-base64: ${{ secrets.APPSTORE_KEY_BASE64 }}
